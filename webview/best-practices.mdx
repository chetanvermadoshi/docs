---
title: "Best Practices"
description: "Optimization tips and best practices for webview authentication"
---

## Security Best Practices

### Always Use HTTPS

<Warning>
  Never use HTTP in production environments
</Warning>
```javascript
// ✅ Correct
const webviewUrl = "https://embed.doshi.app";

// ❌ Never in production
const insecureUrl = "http://embed.doshi.app";
```

### Implement Proper Origin Checks
```javascript
// For postMessage
window.addEventListener("message", (event) => {
  // ✅ Always verify origin in production
  if (event.origin !== 'https://embed.doshi.app') {
    console.warn('Rejected message from:', event.origin);
    return;
  }
  
  // Process message
});
```

### Use Short-Lived Tokens
```javascript
// Generate token with short expiration
const token = generateToken({
  userId: user.id,
  expiresIn: '5m' // 5 minutes
});
```

### Validate All Messages and Parameters
```javascript
function validateAuthData(data) {
  const required = ['token', 'email'];
  const missing = required.filter(field => !data[field]);
  
  if (missing.length > 0) {
    throw new Error(`Missing required fields: ${missing.join(', ')}`);
  }
  
  // Validate email format
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(data.email)) {
    throw new Error('Invalid email format');
  }
  
  return true;
}
```

### Never Use Wildcards in Production
```javascript
// ❌ Development only
webview.contentWindow.postMessage(data, "*");

// ✅ Production
webview.contentWindow.postMessage(data, "https://embed.doshi.app");
```

## Performance Best Practices

### Minimize Cross-Frame Communication

<Tip>
  Send all authentication data in a single message rather than multiple messages
</Tip>
```javascript
// ✅ Send everything at once
const authData = {
  token: user.token,
  email: user.email,
  firstName: user.firstName,
  lastName: user.lastName,
  // ... all data
  type: "AUTH"
};

webview.contentWindow.postMessage(JSON.stringify(authData), origin);

// ❌ Avoid multiple messages
webview.contentWindow.postMessage(JSON.stringify({ token }), origin);
webview.contentWindow.postMessage(JSON.stringify({ email }), origin);
// ...
```

### Use Efficient Message Formats
```javascript
// ✅ Compact format
const message = JSON.stringify({ type: "AUTH", ...authData });

// ❌ Verbose format (avoid unnecessary nesting)
const verboseMessage = JSON.stringify({
  data: {
    authentication: {
      user: {
        credentials: authData
      }
    }
  }
});
```

### Implement Proper Cleanup
```typescript
useEffect(() => {
  const handleMessage = (event: MessageEvent) => {
    // Handle message
  };

  window.addEventListener("message", handleMessage);
  
  // ✅ Always cleanup
  return () => {
    window.removeEventListener("message", handleMessage);
  };
}, []);
```

### Cache Authentication State
```typescript
const [authState, setAuthState] = useState<'pending' | 'authenticated' | 'error'>('pending');
const [authData, setAuthData] = useState<AuthData | null>(null);

// Cache authentication result
const handleAuth = (data: AuthData) => {
  setAuthData(data);
  setAuthState('authenticated');
  
  // Store in session storage for persistence
  sessionStorage.setItem('authState', 'authenticated');
  sessionStorage.setItem('authData', JSON.stringify(data));
};
```

## Error Handling Best Practices

### Comprehensive Error Handling
```typescript
const handleMessage = async (event: MessageEvent) => {
  try {
    // Verify origin
    if (event.origin !== 'https://embed.doshi.app') {
      throw new Error(`Unauthorized origin: ${event.origin}`);
    }
    
    // Parse data
    const data = typeof event.data === "string" 
      ? JSON.parse(event.data) 
      : event.data;
    
    // Validate data
    validateAuthData(data);
    
    // Process data
    await processAuth(data);
    
  } catch (error) {
    console.error('Authentication error:', error);
    
    // Log to monitoring service
    logError(error);
    
    // Update UI
    setAuthState('error');
    setErrorMessage(error.message);
    
    // Notify user
    showNotification('Authentication failed. Please try again.');
  }
};
```

### Log Authentication Failures
```javascript
function logError(error) {
  // Log to console
  console.error('Auth error:', error);
  
  // Send to monitoring service
  if (window.analytics) {
    window.analytics.track('Authentication Failed', {
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
}
```

### Provide User Feedback
```typescript
const [error, setError] = useState<string | null>(null);

const handleAuthError = (error: Error) => {
  setError('Authentication failed. Please refresh and try again.');
  
  // Auto-clear error after 5 seconds
  setTimeout(() => setError(null), 5000);
};

return (
  <div>
    {error && (
      <div className="error-banner">
        {error}
      </div>
    )}
    <iframe src={webviewUrl} />
  </div>
);
```

### Handle Timeout Scenarios
```typescript
const AUTH_TIMEOUT = 10000; // 10 seconds

const waitForAuth = () => {
  return new Promise((resolve, reject) => {
    const timeout = setTimeout(() => {
      reject(new Error('Authentication timeout'));
    }, AUTH_TIMEOUT);
    
    const handleMessage = (event: MessageEvent) => {
      if (event.data.type === 'AUTH') {
        clearTimeout(timeout);
        window.removeEventListener('message', handleMessage);
        resolve(event.data);
      }
    };
    
    window.addEventListener('message', handleMessage);
  });
};
```

## Method Selection Guide

### When to Use postMessage

<Check>Handling sensitive authentication data</Check>
<Check>Need for real-time, bidirectional communication</Check>
<Check>Dynamic authentication flows</Check>
<Check>Multiple authentication steps</Check>
<Check>Maximum security requirements</Check>
```typescript
// Use postMessage for sensitive data
const WebviewSecure = ({ authData }) => {
  // postMessage implementation
  // No sensitive data in URLs
};
```

### When to Use Query Parameters

<Check>Simple, one-time authentication</Check>
<Check>Stateless authentication</Check>
<Check>Need for easier debugging</Check>
<Check>Simpler implementation requirements</Check>
<Check>Data is not highly sensitive</Check>
```typescript
// Use query params for simple auth
const WebviewSimple = ({ authData }) => {
  const url = `https://embed.doshi.app?token=${shortLivedToken}`;
  return <iframe src={url} />;
};
```

## Styling Best Practices

### Responsive Container
```css
.webview-container {
  /* Responsive sizing */
  width: 100%;
  height: 900px;
  max-height: 90vh;
  overflow: hidden;
  
  /* Optional: rounded corners */
  border-radius: 8px;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .webview-container {
    height: 600px;
  }
}
```

### Full-Width Iframe
```css
.webview-container iframe {
  width: 100%;
  height: 100%;
  border: none;
  display: block;
}
```

### Loading State
```tsx
const [isLoading, setIsLoading] = useState(true);

return (
  <div className="webview-container">
    {isLoading && (
      <div className="loading-overlay">
        <div className="spinner" />
        <p>Loading...</p>
      </div>
    )}
    <iframe
      src={webviewUrl}
      onLoad={() => setIsLoading(false)}
      className="h-full w-full"
    />
  </div>
);
```

## Testing Best Practices

### Test in Multiple Environments

<CardGroup cols={2}>
  <Card title="Development" icon="laptop-code">
    Test with localhost and development URLs
  </Card>
  <Card title="Staging" icon="flask">
    Test with staging environment before production
  </Card>
  <Card title="Production" icon="server">
    Use production URLs with proper origin validation
  </Card>
  <Card title="Cross-Browser" icon="browser">
    Test across Chrome, Firefox, Safari, and Edge
  </Card>
</CardGroup>

### Test Authentication Flow
```typescript
// Test helper
const testAuthFlow = async () => {
  console.log('Starting auth test...');
  
  // 1. Test PING
  window.postMessage(JSON.stringify({ type: 'PING' }), '*');
  
  // 2. Wait for AUTH response
  await waitForAuth();
  
  console.log('Auth test completed successfully');
};
```

### Monitor Performance
```javascript
// Measure authentication time
const startTime = performance.now();

window.addEventListener('message', (event) => {
  if (event.data.type === 'AUTH') {
    const endTime = performance.now();
    const duration = endTime - startTime;
    
    console.log(`Authentication took ${duration}ms`);
    
    // Log to analytics
    analytics.track('Auth Performance', { duration });
  }
});
```

## Checklist

### Before Deployment

<Check>Replace all "*" wildcards with specific origins</Check>
<Check>Enable HTTPS for all URLs</Check>
<Check>Implement origin verification</Check>
<Check>Add comprehensive error handling</Check>
<Check>Test across multiple browsers</Check>
<Check>Set up error logging and monitoring</Check>
<Check>Validate all input data</Check>
<Check>Use short-lived tokens</Check>
<Check>Clear sensitive URL parameters</Check>
<Check>Test authentication timeout scenarios</Check>

## Next Steps

<CardGroup cols={2}>
  <Card title="Troubleshooting" icon="wrench" href="/webview/troubleshooting">
    Common issues and solutions
  </Card>
  <Card title="Security Guide" icon="shield" href="/webview/security">
    Review security considerations
  </Card>
</CardGroup>